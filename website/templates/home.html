<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Substation Demo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">-->
    <style>
      .table-borderless td, .table-borderless th {
        border: none !important;
      }
      .clicked {
        background-color: #a5d8ff !important;
      }
      .input-source.disabled {
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center">Smart Substation</h1>
      <table class="table table-borderless mt-4 text-center">
        <thead>
          <tr>
            <th>Input Sources</th>
            <th></th>
            <th>Output Loads</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="align-middle">
              <div class="d-flex flex-column align-items-center">
                <div class="row align-items-center mb-2">
                  <button class="btn btn-light mb-2 input-source col-auto d-flex align-items-center" data-mw="25" data-cost="2.5"><span><span id="title">Thermal</span><br>Rs. <span class="costText">2.5</span> / Unit <br> Capacity: <span class="capacityText">25</span>MW</span></button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil col ms-2 editIcon" style="cursor: pointer;">
                  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                </svg>
                </div>
                <div class="row align-items-center mb-2">
                <button class="btn btn-light mb-2 input-source col-auto d-flex align-items-center" data-mw="25" data-cost="12"><span><span id="title">Gas</span><br>Rs. <span class="costText">12</span> / Unit <br> Capacity: <span class="capacityText">25</span>MW</span></button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil col ms-2 editIcon" style="cursor: pointer;">
                  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                </svg>
                </div>
                <div class="row align-items-center mb-2">
                <button class="btn btn-light mb-2 input-source col-auto d-flex align-items-center" data-mw="40" data-cost="1.05"><span><span id="title">Hydroelectricity</span><br>Rs. <span class="costText">1.05</span> / Unit <br> Capacity: <span class="capacityText">40</span>MW</span></button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil col ms-2 editIcon" style="cursor: pointer;">
                  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                </svg>
                </div>
                <div class="row align-items-center mb-2">
                <button class="btn btn-light mb-2 input-source col-auto d-flex align-items-center" data-mw="50" data-cost="3.5"><span><span id="title">Solar</span><br>Rs. <span class="costText">3.5</span> / Unit <br> Capacity: <span class="capacityText">50</span>MW</span></button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil col ms-2 editIcon" style="cursor: pointer;">
                  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                </svg>
                </div>
                <div class="row align-items-center mb-2">
                <button class="btn btn-light mb-2 input-source col-auto d-flex align-items-center" data-mw="20" data-cost="3"><span><span id="title">Wind</span><br>Rs. <span class="costText">3</span> / Unit <br> Capacity: <span class="capacityText">20</span>MW</span></button>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil col ms-2 editIcon" style="cursor: pointer;">
                  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                </svg>
                </div>
              </div>
            </td>
            <td class="align-middle">
              <div class="d-flex flex-column align-items-center">
                <button class="btn btn-light mb-2" id="total-load" disabled>Total Load: 0MW</button>
                <button class="btn btn-light mb-2" id="available-power" disabled>Total Available Power: 0MW</button>
                <button class="btn btn-light mb-2" id="avg-cost" disabled>Average Power Cost: Rs. 0.00 / Unit</button>
              </div>
            </td>
            <td class="align-middle">
              <div class="d-flex flex-column align-items-center">
                <button class="btn btn-light mb-2 load-button" data-mw="20" aria-label="Load 20 MW">Feeder 1<br>20MW</button>
                <button class="btn btn-light mb-2 load-button" data-mw="30" aria-label="Load 30 MW">Feeder 2<br>30MW</button>
                <button class="btn btn-light mb-2 load-button" data-mw="10" aria-label="Load 10 MW">Feeder 3<br>10MW</button>
                <button class="btn btn-light mb-2 load-button" data-mw="15" aria-label="Load 15 MW">Feeder 4<br>15MW</button>
                <button class="btn btn-light mb-2 load-button" data-mw="10" aria-label="Load 10 MW">Feeder 5<br>10MW</button>
                <button class="btn btn-light mb-2 load-button" data-mw="20" aria-label="Load 20 MW">Feeder 6<br>20MW</button>
                <button class="btn btn-light mb-2 load-button" data-mw="25" aria-label="Load 25 MW">Feeder 7<br>25MW</button>
                <button class="btn btn-light mb-2 load-button" data-mw="10" aria-label="Load 10 MW">Feeder 8<br>10MW</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
    document.querySelectorAll('.editIcon').forEach(editIcon => {
        editIcon.addEventListener('click', function() {
            const row = editIcon.closest('.row');
            const button = row.querySelector('.input-source');
            const costText = row.querySelector('.costText');
            const capacityText = row.querySelector('.capacityText');
            
            const costInput = document.createElement('input');
            costInput.type = 'number';
            costInput.value = costText.textContent.replace('Rs. ', '');
            costInput.className = 'costInput';
            costInput.style.width = '60px';

            const capacityInput = document.createElement('input');
            capacityInput.type = 'number';
            capacityInput.value = capacityText.textContent.replace('MW', '');
            capacityInput.className = 'capacityInput';
            capacityInput.style.width = '50px';

            costText.replaceWith(costInput);
            capacityText.replaceWith(capacityInput);

            costInput.focus();

            function handleEnter(event) {
                if (event.key === 'Enter') {
                    const newCost = parseFloat(costInput.value);
                    const newCapacity = parseFloat(capacityInput.value);

                    if (isNaN(newCost) || isNaN(newCapacity)) {
                        alert("Please enter valid numerical values.");
                        return;
                    }

                    button.setAttribute('data-cost', newCost);
                    button.setAttribute('data-mw', newCapacity);

                    costText.textContent = `${newCost}`;
                    capacityText.textContent = `${newCapacity}`;

                    costInput.replaceWith(costText);
                    capacityInput.replaceWith(capacityText);

                    const titleText = button.querySelector("#title")?.textContent;
                    if (titleText) {
                        localStorage.setItem(titleText + "_costText", costText.textContent);
                        localStorage.setItem(titleText + "_capacityText", capacityText.textContent);
                    } else {
                        console.warn("Title text not found for localStorage key.");
                    }

                    costInput.removeEventListener('keydown', handleEnter);
                    capacityInput.removeEventListener('keydown', handleEnter);
                }
            }

            costInput.addEventListener('keydown', handleEnter);
            capacityInput.addEventListener('keydown', handleEnter);
        });
    });

      const loadButtons = document.querySelectorAll('.load-button');
      const inputSourceButtons = document.querySelectorAll('.input-source');
      const totalLoadBtn = document.getElementById('total-load');
      const availablePowerBtn = document.getElementById('available-power');
      const totalCostBtn = document.getElementById('avg-cost');

      const availablePower = Array.from(inputSourceButtons).reduce((acc, btn) => acc + parseFloat(btn.getAttribute('data-mw')), 0);
      availablePowerBtn.textContent = `Total Available Power: ${availablePower.toFixed(0)}MW`;

      inputSourceButtons.forEach(button => {
        const titleText = button.querySelector("#title")?.textContent;
        if (titleText && isInLocalStorage(titleText + "_costText")) {
            button.querySelector(".costText").textContent = JSON.parse(localStorage.getItem(titleText + "_costText"))
            button.querySelector(".capacityText").textContent = JSON.parse(localStorage.getItem(titleText + "_capacityText"))
            button.setAttribute("data-cost", JSON.parse(localStorage.getItem(titleText + "_costText")));
            button.setAttribute("data-mw", JSON.parse(localStorage.getItem(titleText + "_capacityText")));
        } else {
            console.warn("Title text not found for localStorage key.");
        }
      });

      const sortedInputSourceButtons = Array.from(inputSourceButtons).sort((a, b) => {
          return parseFloat(a.getAttribute('data-cost')) - parseFloat(b.getAttribute('data-cost'));
      });

      function isInLocalStorage(key) {
        return localStorage.getItem(key) !== null;
      }

      loadButtons.forEach(button => {
          button.addEventListener('click', function () {
              button.classList.toggle('clicked');

              let totalLoad = 0;
              loadButtons.forEach(btn => {
                  if (btn.classList.contains('clicked')) {
                      totalLoad += parseFloat(btn.getAttribute('data-mw'));
                  }
              });

              if (totalLoad > availablePower) {
                  alert("Warning: Load demand exceeds available power sources!");
                  button.classList.remove('clicked');
                  return;
              }

              let remainingLoad = totalLoad;
              let weightedCostSum = 0;

              inputSourceButtons.forEach(button => {
                  button.classList.remove('clicked');
                  button.disabled = true
              });

              sortedInputSourceButtons.forEach(button => {
                  const sourceMW = parseFloat(button.getAttribute('data-mw'));
                  const sourceCost = parseFloat(button.getAttribute('data-cost'));

                  if (remainingLoad > 0 && remainingLoad >= sourceMW) {
                      button.classList.add('clicked');
                      button.disabled = false;
                      remainingLoad -= sourceMW;
                      weightedCostSum += sourceMW * sourceCost;
                  } else if (remainingLoad > 0) {
                      button.classList.add('clicked');
                      button.disabled = false;
                      weightedCostSum += remainingLoad * sourceCost;
                      remainingLoad = 0;
                  } else {
                      button.classList.remove('clicked');
                      button.disabled = true;
                  }
              });

              let totalCost = totalLoad > 0 ? (weightedCostSum / totalLoad) : 0;
              totalLoadBtn.textContent = `Total Load: ${totalLoad.toFixed(0)}MW`;
              totalCostBtn.textContent = `Average Power Cost: Rs. ${totalCost.toFixed(2)} / Unit`;
          });
      });
    </script>
  </body>
</html>